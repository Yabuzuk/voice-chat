<!DOCTYPE html>
<html>
<head>
    <title>Простая голосовая связь</title>
</head>
<body>
    <h1>Голосовая связь</h1>
    <div>Статус: <span id="status">Готов</span></div>
    
    <button onclick="createOffer()">1. Создать предложение</button><br><br>
    <textarea id="offer" rows="4" cols="80" placeholder="Предложение появится здесь"></textarea><br><br>
    
    <textarea id="remoteOffer" rows="4" cols="80" placeholder="Или вставьте предложение друга сюда"></textarea><br>
    <button onclick="createAnswer()">2. Ответить на предложение</button><br><br>
    
    <textarea id="answer" rows="4" cols="80" placeholder="Ответ появится здесь"></textarea><br><br>
    
    <textarea id="remoteAnswer" rows="4" cols="80" placeholder="Или вставьте ответ друга сюда"></textarea><br>
    <button onclick="setAnswer()">3. Принять ответ</button>
    
    <script>
        let pc;
        let stream;
        
        async function createOffer() {
            try {
                document.getElementById('status').textContent = 'Запрашиваем микрофон...';
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                document.getElementById('status').textContent = 'Создаем предложение...';
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                stream.getTracks().forEach(track => pc.addTrack(track, stream));
                
                pc.ontrack = event => {
                    const audio = new Audio();
                    audio.srcObject = event.streams[0];
                    audio.play();
                    document.getElementById('status').textContent = 'Говорим!';
                };
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                document.getElementById('offer').value = JSON.stringify(offer);
                document.getElementById('status').textContent = 'Предложение готово! Отправьте другу.';
                
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка: ' + error.message;
            }
        }
        
        async function createAnswer() {
            try {
                const offerText = document.getElementById('remoteOffer').value;
                if (!offerText) return alert('Вставьте предложение');
                
                document.getElementById('status').textContent = 'Запрашиваем микрофон...';
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                stream.getTracks().forEach(track => pc.addTrack(track, stream));
                
                pc.ontrack = event => {
                    const audio = new Audio();
                    audio.srcObject = event.streams[0];
                    audio.play();
                    document.getElementById('status').textContent = 'Говорим!';
                };
                
                await pc.setRemoteDescription(JSON.parse(offerText));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                document.getElementById('answer').value = JSON.stringify(answer);
                document.getElementById('status').textContent = 'Ответ готов! Отправьте другу.';
                
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка: ' + error.message;
            }
        }
        
        async function setAnswer() {
            try {
                const answerText = document.getElementById('remoteAnswer').value;
                if (!answerText) return alert('Вставьте ответ');
                
                await pc.setRemoteDescription(JSON.parse(answerText));
                document.getElementById('status').textContent = 'Соединяемся...';
                
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка: ' + error.message;
            }
        }
    </script>
</body>
</html>