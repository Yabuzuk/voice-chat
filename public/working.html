<!DOCTYPE html>
<html>
<head>
    <title>Рабочая версия</title>
    <style>
        body { font-family: Arial; text-align: center; padding: 20px; }
        button { padding: 15px 30px; margin: 10px; font-size: 18px; }
        #status { font-size: 20px; margin: 20px; }
        .audio-controls { margin: 20px; padding: 20px; border: 2px solid #ccc; }
    </style>
</head>
<body>
    <h1>Голосовая связь</h1>
    <div id="status">Подключение...</div>
    
    <button onclick="enableAudio()">1. Включить звук</button>
    <button id="callBtn" onclick="makeCall()" disabled>2. Позвонить</button>
    
    <div class="audio-controls">
        <h3>Управление звуком:</h3>
        <button onclick="testSound()">Тест звука</button>
        <button onclick="toggleMute()">Выкл/Вкл микрофон</button>
        <div id="audioContainer"></div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let pc;
        let localStream;
        let isOfferer = false;
        let answerProcessed = false;
        let audioEnabled = false;
        let remoteAudio = null;
        
        socket.on('connect', () => {
            document.getElementById('status').textContent = 'Подключен. Сначала включите звук.';
        });
        
        async function enableAudio() {
            try {
                // Создаем аудио контекст для разблокировки звука
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                await audioContext.resume();
                
                // Тестовый звук
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
                
                audioEnabled = true;
                document.getElementById('callBtn').disabled = false;
                document.getElementById('status').textContent = 'Звук включен! Теперь можно звонить.';
                
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка звука: ' + error.message;
            }
        }
        
        function testSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);
        }
        
        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('status').textContent = audioTrack.enabled ? 'Микрофон включен' : 'Микрофон выключен';
            }
        }
        
        socket.on('offer', async (offer) => {
            if (isOfferer) return;
            
            try {
                document.getElementById('status').textContent = 'Входящий звонок...';
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                pc = new RTCPeerConnection({ 
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                
                pc.ontrack = event => {
                    document.getElementById('status').textContent = 'Получен звук!';
                    
                    // Создаем аудио элемент
                    remoteAudio = document.createElement('audio');
                    remoteAudio.srcObject = event.streams[0];
                    remoteAudio.autoplay = true;
                    remoteAudio.controls = true;
                    remoteAudio.volume = 1.0;
                    remoteAudio.style.width = '100%';
                    
                    document.getElementById('audioContainer').innerHTML = '<h4>Удаленный звук:</h4>';
                    document.getElementById('audioContainer').appendChild(remoteAudio);
                    
                    // Принудительно включаем
                    setTimeout(() => {
                        remoteAudio.play().then(() => {
                            document.getElementById('status').textContent = 'Разговариваем! Звук работает.';
                        }).catch(e => {
                            document.getElementById('status').textContent = 'Нажмите PLAY на аудио плеере!';
                        });
                    }, 1000);
                };
                
                pc.onicecandidate = event => {
                    if (event.candidate) socket.emit('ice-candidate', event.candidate);
                };
                
                await pc.setRemoteDescription(offer);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('answer', answer);
                
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка: ' + error.message;
            }
        });
        
        socket.on('answer', async (answer) => {
            if (!isOfferer || answerProcessed) return;
            
            try {
                answerProcessed = true;
                await pc.setRemoteDescription(answer);
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка: ' + error.message;
            }
        });
        
        socket.on('ice-candidate', async (candidate) => {
            if (pc && pc.remoteDescription) {
                try {
                    await pc.addIceCandidate(candidate);
                } catch (error) {
                    console.log('ICE error:', error);
                }
            }
        });
        
        async function makeCall() {
            if (!audioEnabled) {
                alert('Сначала включите звук!');
                return;
            }
            
            try {
                isOfferer = true;
                document.getElementById('status').textContent = 'Запрашиваем микрофон...';
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                pc = new RTCPeerConnection({ 
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                
                pc.ontrack = event => {
                    document.getElementById('status').textContent = 'Получен звук!';
                    
                    remoteAudio = document.createElement('audio');
                    remoteAudio.srcObject = event.streams[0];
                    remoteAudio.autoplay = true;
                    remoteAudio.controls = true;
                    remoteAudio.volume = 1.0;
                    remoteAudio.style.width = '100%';
                    
                    document.getElementById('audioContainer').innerHTML = '<h4>Удаленный звук:</h4>';
                    document.getElementById('audioContainer').appendChild(remoteAudio);
                    
                    setTimeout(() => {
                        remoteAudio.play().then(() => {
                            document.getElementById('status').textContent = 'Разговариваем! Звук работает.';
                        }).catch(e => {
                            document.getElementById('status').textContent = 'Нажмите PLAY на аудио плеере!';
                        });
                    }, 1000);
                };
                
                pc.onicecandidate = event => {
                    if (event.candidate) socket.emit('ice-candidate', event.candidate);
                };
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('offer', offer);
                
                document.getElementById('status').textContent = 'Звоним...';
                document.getElementById('callBtn').disabled = true;
                
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка: ' + error.message;
            }
        }
    </script>
</body>
</html>